Meteor.methods({
  sendEmailTask(toUser, myActionId) {
    var emailString = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body yahoo="" bgcolor="#ffffff" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; margin: 0; padding: 0; min-width: 100%;"><table width="100%" bgcolor="#ffffff" border="0" cellpadding="10" cellspacing="0"'; emailString = emailString + ' style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; mso-table-lspace: 0pt; mso-table-rspace: 0pt; border-collapse: collapse;"><tr> <td style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; mso-table-lspace: 0pt; mso-table-rspace: 0pt;"> <table bgcolor="#ffffff" class="content" align="center" cellpadding="0"'; emailString=emailString + 'cellspacing="0" border="0" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%;'; emailString = emailString + ' mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; max-width: 600px; border-collapse: collapse;" width="100%"> <tr><td align="center" valign="top" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; mso-table-lspace: 0pt; mso-table-rspace: 0pt;"><table border="0" cellpadding="0" cellspacing="0" width="100%" id="templateContainerImageCurve"'; emailString=emailString + 'style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; mso-table-lspace: 0pt; mso-table-rspace: 0pt; border-top: 1px solid #e2e2e2; border-left: 1px solid #e2e2e2; border-right: 1px solid #e2e2e2; border-radius: 3px 3px 0px 0px; background-clip: padding-box; border-spacing: 0; min-height: 15px; border-collapse: separate;"><tr><td valign="top" class="bodyContentImageFull" mc:edit="body_content_01" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; mso-table-lspace: 0pt; mso-table-rspace: 0pt;"> <p style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; color: #545454; display: block; font-family: Helvetica; line-height: 1.500em; font-style: normal; font-weight: normal; letter-spacing: normal; margin-top: 0; margin-right: 0; margin-left: 0; text-align: center; margin: 0; padding: 0; font-size: 0; margin-bottom: 0;"> <img src="http://52.163.112.248/logo.png" style="max-width: 100%; border: 0; line-height: 100%; outline: none; text-decoration: none; height: auto; min-height: 1px; border-radius: 3px 3px 0px 0px; background-clip: padding-box; display: block;"> </p></td></tr></table></td></tr><tr><td align="center" valign="top" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; mso-table-lspace: 0pt; mso-table-rspace: 0pt;"><table border="0" cellpadding="0" cellspacing="0" width="100%" id="templateContainerMiddle" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; mso-table-lspace: 0pt; mso-table-rspace: 0pt; border-left: 1px solid #e2e2e2; border-right: 1px solid #e2e2e2; border-collapse: collapse;"><tr><td valign="top" class="bodyContent" mc:edit="body_content" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; mso-table-lspace: 0pt; mso-table-rspace: 0pt; color: #505050; font-family: Helvetica; font-size: 14px; line-height: 150%; padding-top: 3.143em; padding-right: 3.5em; padding-left: 3.5em; padding-bottom: 0.714em; text-align: left;" align="left"> <h3 style="color: #545454; display: block; font-family: Helvetica; font-size: 18px; line-height: 1.444em; font-style: normal; font-weight: normal; letter-spacing: normal; margin-top: 0; margin-right: 0; margin-bottom: 15px; margin-left: 0; text-align: left;">##FIRSTNAME##</h3><h2 style="color: #2e2e2e; display: block; font-family: Helvetica; font-size: 22px; line-height: 1.455em; font-style: normal; font-weight: normal; letter-spacing: normal; margin-top: 0; margin-right: 0; margin-bottom: 15px; margin-left: 0; text-align: left;">New Task</h2><p style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; color: #545454; display: block; font-family: Helvetica; font-size: 16px; line-height: 1.500em; font-style: normal; font-weight: normal; letter-spacing: normal; margin-top: 0; margin-right: 0; margin-bottom: 15px; margin-left: 0; text-align: left;">##USERNAME## has created a new task within GreenKPI for you to action. Can you please update the task within GreenKPI when it is complete. With GreenKPI you can update the plan date, record notes, and complete the task, just click on the button below.</p><p style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; color: #545454; display: block; font-family: Helvetica; font-size: 16px; line-height: 1.500em; font-style: normal; font-weight: normal; letter-spacing: normal; margin-top: 0; margin-right: 0; margin-bottom: 15px; margin-left: 0; text-align: left;"><b>Task Details</b></p><p style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; color: blue; display: block; font-family: Helvetica; font-size: 16px; line-height: 1.500em; font-style: italic; font-weight: normal; letter-spacing: normal; margin-top: 0; margin-right: 0; margin-bottom: 15px; margin-left: 0; text-align: left;">##TASK##</p><p><b>Notes:</b></p><pre>##NOTES##</pre></td></tr></table></td></tr><tr><td align="center" valign="top" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; mso-table-lspace: 0pt; mso-table-rspace: 0pt;"><table border="0" cellpadding="0" cellspacing="0" width="100%" id="templateContainerMiddle" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; mso-table-lspace: 0pt; mso-table-rspace: 0pt; border-left: 1px solid #e2e2e2; border-right: 1px solid #e2e2e2; border-collapse: collapse;"><tr><td valign="top" class="bodyContentCenter" mc:edit="body_content_centered" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; mso-table-lspace: 0pt; mso-table-rspace: 0pt; color: #505050; font-family: Helvetica; font-size: 14px; line-height: 150%; padding-top: 0em; padding-right: 3.5em; padding-left: 3.5em; padding-bottom: 3.0em; text-align: center;" align="center"> <a class="blue-btn" href="##URL_UPDATE##" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; background: #5098ea; display: inline-block; color: #FFFFFF; border-top: 10px solid #5098ea; border-bottom: 10px solid #5098ea; border-bottom: 10px solid #5098ea; border-left: 20px solid #5098ea; border-right: 20px solid #5098ea; text-decoration: none; font-size: 14px; border-radius: 3px 3px 3px 3px; background-clip: padding-box; margin-top: 0;"><strong>Update Task</strong></a></td></tr></table></td></tr><tr><td align="center" valign="top" id="bodyCellFooter" class="unSubContent" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; mso-table-lspace: 0pt; mso-table-rspace: 0pt; margin: 0; padding: 0; padding-top: 39px; padding-bottom: 15px; width: 100%;" width="100%"><table width="100%" border="0" cellpadding="0" cellspacing="0" id="templateContainerFooter" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; mso-table-lspace: 0pt; mso-table-rspace: 0pt; border-collapse: collapse;"><tr><td valign="top" width="100%" mc:edit="footer_unsubscribe" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; mso-table-lspace: 0pt; mso-table-rspace: 0pt;"><p style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; color: #545454; display: block; font-family: Helvetica; font-size: 16px; line-height: 1.500em; font-style: normal; font-weight: normal; letter-spacing: normal; margin-top: 0; margin-right: 0; margin-bottom: 15px; margin-left: 0; text-align: center;"><img src="http://c0185784a2b233b0db9b-d0e5e4adc266f8aacd2ff78abb166d77.r51.cf2.rackcdn.com/templates/cog-03.jpg" style="max-width: 100%; border: 0; line-height: 100%; outline: none; text-decoration: none; height: auto; min-height: 1px; margin: 0 auto 0 auto; display: inline-block;"></p><h6 style="display: block; font-family: Helvetica; font-style: normal; font-weight: normal; letter-spacing: normal; margin-right: 0; margin-left: 0; color: #a1a1a1; font-size: 12px; line-height: 1.5em; margin-bottom: 0; text-align: center; margin-top: 9px;">GreenKPI</h6><h6 style="display: block; font-family: Helvetica; font-style: normal; font-weight: normal; letter-spacing: normal; margin-top: 0; margin-right: 0; margin-left: 0; color: #a1a1a1; font-size: 12px; line-height: 1.5em; margin-bottom: 0; text-align: center;">Queensland, Australia</h6><h6 style="display: block; font-family: Helvetica; font-style: normal; font-weight: normal; letter-spacing: normal; margin-right: 0; margin-left: 0; color: #a1a1a1; font-size: 12px; line-height: 1.5em; margin-bottom: 0; text-align: center; margin-top: 7px;"><a href="##URL_UNSUB##" style="-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%;">unsubscribe</a></h6></td></tr></table></td></tr></table> </td></tr></table><style type="text/css">@media only screen and (max-width: 550px), screen and (max-device-width: 550px){body[yahoo] .hide{display: none!important;}body[yahoo] .buttonwrapper{background-color: transparent!important;}body[yahoo] .button{padding: 0px!important;}body[yahoo] .button a{background-color: #e05443; padding: 15px 15px 13px!important;}body[yahoo] .unsubscribe{font-size: 14px; display: block; margin-top: 0.714em; padding: 10px 50px; background: #2f3942; border-radius: 5px; text-decoration: none!important;}}@media only screen and (max-width: 480px){h1{font-size: 34px !important;}h2{font-size: 30px !important;}h3{font-size: 24px !important;}h4{font-size: 18px !important;}h5{font-size: 16px !important;}h6{font-size: 14px !important;}p{font-size: 18px !important;}.brdBottomPadd .bodyContent{padding-bottom: 2.286em !important;}.bodyContent{padding: 6% 5% 1% 6% !important;}.bodyContent img{max-width: 100% !important;}.bodyContentImage{padding: 3% 6% 6% 6% !important;}.bodyContentImage img{max-width: 100% !important;}.bodyContentImage h4{font-size: 16px !important;}.bodyContentImage h5{font-size: 15px !important; margin-top: 0;}td[class="bodyContentCenter"]{padding: 6% 6% 6% 6% !important;}}</style></body></html>';

    var taskDetails = "";

    var actionRec = MyActions.findOne({_id: myActionId});
    var to = "";
    var toRec;

    toRec = MyStaff.findOne({_id: toUser});
    to = toRec.emailAddress;

    var userName = Meteor.user().profile.name;

    var noteText = "";

    var noteRec = MyActionNotes.find({actionId: this._id, activeFlag:true},  {sort: {noteDate: -1}}).fetch();

    for (var i = 0; i < noteRec.length; i++) {
      noteText = noteText + noteRec[i].noteText + '<br/>';
    }

    emailString = emailString.replace("##FIRSTNAME##", toRec.firstName + ', ');
    emailString = emailString.replace("##USERNAME##", userName);
    emailString = emailString.replace("##TASK##", actionRec.actionText);
    emailString = emailString.replace("##NOTES##", noteText);
    emailString = emailString.replace("##URL_UPDATE##", Meteor.absoluteUrl("updateTask/" + myActionId));
    emailString = emailString.replace("##URL_UNSUB##", Meteor.absoluteUrl("unsub/" + toRec._id));

    var from = "support@greenkpi.com.au";
    var subject = "GreenKPI: New Task";

    Meteor.call('sendEmail', to, from, subject, emailString )

},
sendEmail(to, from, subject, html) {
  // Make sure that all arguments are strings.
//    check([to, from, subject, text], [String]);

  // Let other method calls from the same client start running, without
  // waiting for the email sending to complete.
  this.unblock();

  Email.send({ to, from, subject, html });
},
});
